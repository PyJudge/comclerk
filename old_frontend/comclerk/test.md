# ComClerk Playwright E2E 테스트 계획

## 🎯 구현 대상

### **5개 핵심 사용자 시나리오**
1. **첫 방문자 완전 업무 플로우** - 파일 업로드→뷰어→채팅 전체 과정
2. **전문가 다중 문서 비교** - 3개 계약서 업로드하여 비교 분석  
3. **네트워크 오류 복구** - 불안정한 환경에서 재시도 및 복구
4. **잘못된 파일 처리** - 비PDF, 손상파일, 대용량 파일 오류 처리
5. **세션 지속성 확인** - 새로고침 후 파일 유지/채팅 초기화 확인

### **테스트 구조**
```
tests/
├── e2e/
│   ├── critical-workflows.spec.ts    # 시나리오 1, 5
│   ├── advanced-workflows.spec.ts    # 시나리오 2  
│   ├── error-handling.spec.ts        # 시나리오 3, 4
├── fixtures/                         # 테스트용 PDF 파일들
└── helpers/                          # 페이지 객체 및 유틸리티
```

## 📋 시나리오 상세 스펙

### **시나리오 1: 첫 방문자 완전 업무 플로우** (@critical)

**검증 대상:**
- 3단 레이아웃 로딩 확인
- 드래그앤드롭 파일 업로드 (B1 컴포넌트)
- A1 API 호출 및 200 응답 확인
- A2 API로 파일 목록 갱신
- 사이드바에 파일 표시 (C1 통합)
- PDF 뷰어 렌더링 (B3 컴포넌트)
- 페이지 네비게이션 동작
- 채팅 메시지 전송 (B2 컴포넌트)
- A3 SSE 스트리밍 응답 수신
- 연속 질문 및 응답 누적

**시나리오 플로우:**
1. 페이지 접속 → 3단 레이아웃 확인
2. PDF 파일 드래그앤드롭 → 업로드 프로그레스 → 성공 메시지
3. 사이드바에 파일 자동 표시 → 파일 클릭
4. PDF 뷰어 로딩 → 페이지 네비게이션 테스트
5. 채팅 입력 → SSE 스트리밍 응답 → 추가 질문

### **시나리오 2: 전문가 다중 문서 비교** (@advanced)

**검증 대상:**
- 연속 파일 업로드 (3개)
- 파일 목록에 순차 표시
- 문서 간 전환 시 선택 상태 변경
- 각 문서별 독립적 PDF 뷰어 동작
- 채팅 히스토리 유지 (메모리 기반)
- 문서 컨텍스트 기반 질문-응답

**시나리오 플로우:**
1. 계약서_v1.pdf, v2.pdf, 마스터_계약서.pdf 연속 업로드
2. 사이드바에 3개 파일 모두 표시 확인
3. 첫 번째 문서 선택 → 특정 페이지 이동 → 질문
4. 두 번째 문서로 전환 → 선택 상태 변경 확인 → 비교 질문
5. 세 번째 문서로 전환 → 종합 분석 질문
6. 채팅 히스토리 누적 확인

### **시나리오 3: 네트워크 오류 복구** (@error)

**검증 대상:**
- API 응답 차단으로 네트워크 오류 시뮬레이션
- 오류 메시지 표시 (앱은 계속 동작)
- 재시도 버튼 동작
- 연결 복구 후 정상 동작
- 실패한 메시지 재전송

**시나리오 플로우:**
1. 정상 파일 업로드 → 성공 확인
2. 네트워크 차단 → 파일 목록 새로고침 시도
3. 네트워크 오류 메시지 표시 → 앱은 멈추지 않음
4. 채팅 전송 시도 → 메시지 전송 실패 표시
5. 네트워크 복구 → 재시도 버튼 → 정상 동작 확인

### **시나리오 4: 잘못된 파일 처리** (@error)

**핵심 원칙**: 오류 발생 시에도 애플리케이션이 멈추지 않고 계속 동작

**검증 대상:**
- 비PDF 파일 업로드 → 알림 메시지, 앱 정상 동작
- 손상된 PDF 파일 → 에러 표시, 다른 파일 업로드 가능
- 대용량 파일 → 크기 제한 알림, 정상 파일로 복구 가능
- 각 오류 후에도 PDF 뷰어, 채팅 기능 정상 작동
- 연속된 오류 상황에서도 앱 안정성 유지

**시나리오 플로우:**
1. 텍스트 파일(.txt) 업로드 → 400 에러 → 타입 오류 알림 → 앱 계속 동작
2. 손상된 PDF 업로드 → 파일 검증 실패 → 오류 알림 → 앱 계속 동작
3. 대용량 파일 업로드 → 크기 제한 오류 → 알림 표시 → 앱 계속 동작
4. 정상 PDF로 복구 → 모든 오류 메시지 제거 → 정상 업로드
5. PDF 뷰어, 채팅 기능 정상 작동 확인

### **시나리오 5: 세션 지속성 확인** (@critical)

**검증 대상:**
- 파일 업로드 및 채팅 세션 생성
- 브라우저 새로고침 실행
- A2 API로 파일 목록 복원 확인
- 채팅 히스토리 초기화 (메모리 기반)
- 업무 재개 가능성 검증

**시나리오 플로우:**
1. 파일 2개 업로드 → 첫 번째 파일 선택
2. 채팅 2개 진행 → 메시지 누적 확인
3. 브라우저 새로고침 → 페이지 재로딩
4. 파일 목록 복원 확인 → 채팅 히스토리 초기화 확인
5. 두 번째 파일 선택 → 새로운 채팅 시작 → 정상 동작 확인

## 🛠️ 구현 요구사항

### **data-testid 속성**
모든 테스트 대상 요소에 data-testid 속성 필수:

**기존 테스트 요소:**
- `main-layout`, `upload-area`, `file-item`, `pdf-canvas`
- `message-input`, `send-button`, `user-message`, `ai-message`
- `page-indicator`, `next-page`, `prev-page`, `page-input`
- `upload-progress`, `upload-success`
- `network-error`, `retry-button`, `message-failed`
- `file-type-error`, `corrupted-file-error`, `size-limit-error`

**UI 개선사항 테스트 요소:**
- `panel-resize-handle-left`, `panel-resize-handle-right` (패널 크기 조정)
- `left-panel`, `center-panel`, `right-panel` (패널 영역)
- `file-name-display`, `file-info-removed` (파일 표시 개선)
- `chat-scroll-area`, `chat-message-container` (채팅 스크롤)
- `auto-scroll-indicator`, `scroll-to-bottom` (스크롤 동작)

### **API 응답 형식**
- `/api/upload`: 200 성공, 400 파일 타입 오류, 413 크기 초과
- `/api/files`: JSON 배열 (name, size, createdAt, path)
- `/api/stream`: SSE 형식 스트리밍 응답

### **테스트 픽스처**
- 정상 PDF: 계약서.pdf, 문서1.pdf, 문서2.pdf
- 다중 문서: 계약서_v1.pdf, 계약서_v2.pdf, 마스터_계약서.pdf
- 오류 테스트: 문서.txt, 손상된파일.pdf, 대용량파일.pdf

### **오류 처리 원칙**
- 모든 오류 상황에서 애플리케이션이 멈추지 않음
- 오류 메시지는 사용자 친화적으로 표시
- 오류 후에도 다른 기능들은 계속 정상 동작
- 연속된 오류에도 안정성 유지

### **시나리오 6: 3단계 UI 개선사항 검증** (@ui-improvements)

**개선 대상:**
1. **3-Panel 크기 조정**: 드래그로 패널 너비 조정 기능
2. **PDF 파일 표시 최적화**: .pdf 확장자 제거, 글씨 작게, 용량/날짜 제거
3. **채팅 독립 스크롤**: 채팅 영역만 스크롤, 최신 메시지 자동 포커스

**시나리오 6A: 패널 크기 조정 기능** (@panel-resize)
- 패널 경계에 resize 핸들 표시 확인
- 왼쪽 패널 최소 200px ~ 최대 500px 제한 확인
- 오른쪽 패널 최소 300px ~ 최대 600px 제한 확인
- 드래그 시 실시간 크기 조정 동작 확인
- 크기 조정 후 PDF 뷰어 레이아웃 정상 동작 확인

**시나리오 6B: PDF 파일 표시 개선** (@file-display)
- 파일 목록에서 .pdf 확장자 제거 확인
- 파일명 글씨 크기 기존 대비 축소 확인
- 용량 정보 (HardDrive 아이콘) 제거 확인
- 날짜 정보 (Calendar 아이콘) 제거 확인
- 파일 선택 시 정상 동작 유지 확인

**시나리오 6C: 채팅 스크롤 최적화** (@chat-scroll)
- 긴 채팅 대화 시 채팅 영역만 독립 스크롤 확인
- 새 메시지 도착 시 자동으로 최신 메시지로 스크롤
- 스크롤 중 새 메시지 도착해도 자동 포커스 동작
- 사용자가 위로 스크롤한 상태에서 새 메시지 처리
- 채팅 스크롤과 PDF 뷰어 스크롤 독립 동작 확인

### **실행 명령어**
```bash
npm run test:e2e                         # 전체 실행
npm run test:e2e -- --grep "@critical"   # 핵심 시나리오 (1, 5)
npm run test:e2e -- --grep "@advanced"   # 고급 기능 (2)
npm run test:e2e -- --grep "@error"      # 오류 처리 (3, 4)
npm run test:e2e -- --grep "@ui-improvements"  # UI 개선사항 (6)
npm run test:e2e -- --grep "@panel-resize"     # 패널 크기 조정 (6A)
npm run test:e2e -- --grep "@file-display"     # 파일 표시 개선 (6B)
npm run test:e2e -- --grep "@chat-scroll"      # 채팅 스크롤 개선 (6C)
```

## 🎯 성공 기준

- 모든 5개 시나리오 통과
- 각 시나리오별 핵심 검증 포인트 100% 달성
- 실제 구현된 API 및 컴포넌트와 정확히 매칭
- Chrome, Firefox, Safari에서 동일 결과
- 오류 상황에서도 애플리케이션 안정성 보장